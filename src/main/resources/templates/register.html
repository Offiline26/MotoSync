<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/_head :: head('Cadastro')}"></head>
<body>

<main class="container" th:with="isEdit=${false}">
    <div class="header">
        <h1>Cadastro</h1>
        <a class="btn" th:href="@{/login}">Voltar ao login</a>
    </div>

    <div th:if="${error}" class="alert danger" th:text="${error}"></div>

    <form th:action="@{/register}" method="post">

        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>

        <input type="email" name="email" required
               th:value="${form != null ? form.email : ''}" />

        <input type="password" name="password" required />

        <div th:if="${isAdmin}">
            <label for="cargo">Cargo</label>
            <select id="cargo" name="cargo" th:value="${form != null ? form.cargo : 'OPERADOR_PATIO'}">
                <option value="ADMIN">Admin</option>
                <option value="OPERADOR_PATIO">Operador de pátio</option>
            </select>
        </div>

        <input type="hidden" name="cargo" value="OPERADOR_PATIO" th:if="${!isAdmin}"/>

        <div id="patioRow"
             th:with="ehOperador=${isAdmin ? (form != null ? form.cargo == 'OPERADOR_PATIO' : true) : true}"
             th:attr="style=${ehOperador} ? '' : 'display:none'">
            <label for="patioId">Pátio</label>
            <select id="patioId" name="patioId"
                    th:required="${ehOperador}"
                    th:disabled="${!ehOperador}">
                <option value="" hidden th:selected="${form == null || form.patioId == null}">Selecione...</option>
                <option th:each="p : ${patios}" th:value="${p.id}" th:text="${p.nome}"
                        th:selected="${form != null && form.patioId == p.id}"></option>
            </select>
        </div>

        <button type="submit">Cadastrar</button>
    </form>

    <script>

        document.addEventListener('DOMContentLoaded', function () {
            const cargo = document.getElementById('cargo');
            if (!cargo) return;

            function togglePatio() {
                const operador = cargo.value === 'OPERADOR_PATIO';
                const patioRow = document.getElementById('patioRow');
                const patio = document.getElementById('patioId');
                patioRow.style.display = operador ? '' : 'none';
                patio.toggleAttribute('required', operador);
                patio.toggleAttribute('disabled', !operador);
                if (!operador) patio.value = '';
            }
            togglePatio();
            cargo.addEventListener('change', togglePatio);
        });
    </script>

</main>
</body>
</html>